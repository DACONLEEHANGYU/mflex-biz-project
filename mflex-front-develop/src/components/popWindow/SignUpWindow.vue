<template>
  <div class="pop-window">
    <div class="window-header">íšŒì›ê°€ì…</div>
    <div class="signup-body" style="margin-bottom: 15px">
      <div class="window-content pt15">
        <div class="signup-form">
          <div class="form-group">
            <label for="username">ì‚¬ìš©ì ì´ë¦„</label>
            <input
              type="text"
              id="username"
              v-model="userInfo.username"
              placeholder="ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="id">ì•„ì´ë””</label>
            <input
              type="id"
              id="id"
              v-model="userInfo.userId"
              placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="userPassword">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              :type="passwordVisible ? 'text' : 'password'"
              id="userPassword"
              v-model="userInfo.userPassword"
              placeholder="ë¹„ë°€ë²ˆí˜¸ëŠ” 8~16ì ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤."
            />
            <button
              class="check-password-btn"
              @click="togglePasswordVisibility"
            >
              {{ passwordVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
            </button>
          </div>
          <div class="form-group">
            <label for="confirm-password">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input
              :type="confirmPasswordVisible ? 'text' : 'password'"
              id="confirm-password"
              v-model="userInfo.confirmPassword"
              placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
            />
            <button
              class="confirm-password-btn"
              @click="toggleConfirmPasswordVisibility"
            >
              {{ confirmPasswordVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
            </button>
          </div>
          <div class="form-group">
            <label for="confirm-password">íšŒì‚¬ ì „í™”ë²ˆí˜¸</label>
            <input
              type="text"
              v-model="userInfo.officePhoneNumber"
              placeholder="'-'ë¥¼ ì œì™¸í•œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="confirm-password">íœ´ëŒ€í°ë²ˆí˜¸</label>
            <input
              type="text"
              id="confirm-password"
              v-model="userInfo.personalPhoneNumber"
              placeholder="íœ´ëŒ€í°ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
            />
          </div>
          <div class="form-group">
            <label for="confirm-password">ì´ë©”ì¼</label>
            <input
              type="text"
              id="confirm-password"
              v-model="userInfo.email"
              placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
            />
          </div>
          <!-- <div class="form-group form-section child-section">
            <div class="label-section">
              <label class="child-label">ì‚¬ìš©ì íƒ€ì…</label>
            </div>
          
            <div class="select-container">
              <select name="" id="select-usertype">
                <option value="">ê¸°ê´€ì„ íƒ</option>
                <option value="">ë°ì´ì½˜ì¸í”¼ë‹ˆí‹°</option>
                <option value="">ë°ì´ì½˜ë©</option>
              </select>
            </div>
          </div> -->
          <!-- <div
            style="border: 1px solid #ccc; border-radius: 10px; padding: 20px"
          >
            <div class="form-group form-group form-section child-section">
              <div class="label-section child-label">
                <label for="permission">ê¸°ê´€</label>
              </div>
              <div class="select-container">
                <select name="" id="select-institute">
                  <option value="">ê¸°ê´€ì„ íƒ</option>
                  <option value="">ë°ì´ì½˜ì¸í”¼ë‹ˆí‹°</option>
                  <option value="">ë°ì´ì½˜ë©</option>
                </select>
              </div>
            </div>
            <div style="display: flex; justify-content: space-around">
              <div class="form-group form-section child-section">
                <div class="label-section">
                  <label for="permission">ë¶€ì„œ</label>
                </div>
                <div class="select-container">
                  <select name="" id="select-department">
                    <option value="">ê¶Œí•œ</option>
                    <option value="">ê´€ë¦¬ì</option>
                    <option value="">ì¼ë°˜ì‚¬ìš©ì</option>
                  </select>
                </div>
              </div>
              <div class="form-group form-section child-section">
                <div class="label-section child-label">
                  <label for="permission">ì§ê¸‰</label>
                </div>
                <div class="select-container">
                  <select name="" id="select-position">
                    <option value="">ê¶Œí•œ</option>
                    <option value="">ê´€ë¦¬ì</option>
                    <option value="">ì¼ë°˜ì‚¬ìš©ì</option>
                  </select>
                </div>
              </div>
            </div>
          </div> -->
          <div class="form-group"></div>
          <!-- <div class="error-message">
            ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </div> -->
        </div>
      </div>
    </div>
    <div class="window-footer">
      <div class="inputs-btns">
        <div class="btns__r">
          <button class="btn-m confirm" @click="onSignUp">íšŒì›ê°€ì…</button>
          <button class="btn-m close" @click="onCancel">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>
  <AppDialog
    v-model:view="dialogState.view"
    :title="dialogState.title"
    :message="dialogState.message"
    @confirm="onDialogClose"
    @close="onDialogClose"
  />

  <AppDialog
    v-model:view="errorState.view"
    :title="errorState.title"
    :message="errorState.message"
    @confirm="onCloseErrorState"
    @close="onCloseErrorState"
  >
  </AppDialog>
</template>

<script setup>
  import { ref, reactive, onBeforeMount } from 'vue';
  import {
    signUp, // íšŒì›ê°€ì…
  } from '@/utils/mflexApi/loginApi';
  import {
    getUserTypeList,
    getUserPositionList,
    getDepartmentByInstitute,
  } from '@/utils/mflexApi/userManagementApi';
  import AppDialog from '../ui/AppDialog.vue';

  const passwordVisible = ref(false);
  const confirmPasswordVisible = ref(false);

  const emits = defineEmits(['close', 'cofirm']);

  const dialogState = reactive({
    view: false,
    title: '',
    message: '',
  });

  const errorState = reactive({
    view: false,
    title: 'íšŒì›ê°€ì… ì˜¤ë¥˜',
    message: '',
  });

  const userInfo = reactive({
    username: '',
    userId: '',
    userPassword: '',
    confirmPassword: '',
    officePhoneNumber: null,
    personalPhoneNumber: null,
    email: null,
  });

  const togglePasswordVisibility = () => {
    passwordVisible.value = !passwordVisible.value;
  };

  const toggleConfirmPasswordVisibility = () => {
    confirmPasswordVisible.value = !confirmPasswordVisible.value;
  };

  const errorMessage = ref('');

  const validateForm = () => {
    // ì‚¬ìš©ì ì´ë¦„ ê²€ì‚¬
    if (!userInfo.username.trim()) {
      errorState.view = true;
      errorState.message = 'ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      // errorMessage.value = 'ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      return false;
    }

    // ì•„ì´ë”” ê²€ì‚¬ (ìµœì†Œ 4ì ì´ìƒ)
    if (userInfo.userId.length < 5) {
      errorState.view = true;

      errorState.message = 'ì•„ì´ë””ëŠ” ìµœì†Œ 5ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
      // errorMessage.value = 'ì•„ì´ë””ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
      return false;
    }

    // ë¹„ë°€ë²ˆí˜¸ ê²€ì‚¬
    const passwordRegex =
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,16}$/;
    if (!passwordRegex.test(userInfo.userPassword)) {
      errorState.view = true;
      errorState.message =
        'ë¹„ë°€ë²ˆí˜¸ëŠ” 8~16ì ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
      // errorMessage.value =
      //   'ë¹„ë°€ë²ˆí˜¸ëŠ” 8~16ì ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
      return false;
    }

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (userInfo.userPassword !== userInfo.confirmPassword) {
      errorState.view = true;
      errorState.message = 'ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      // errorMessage.value = 'ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      return false;
    }

    return true;
  };

  const onSignUp = async () => {
    const signUpInfo = {
      userId: userInfo.userId,
      userName: userInfo.username,
      userPassword: userInfo.userPassword,
      officePhoneNumber: userInfo.officePhoneNumber,
      personalPhoneNumber: userInfo.personalPhoneNumber,
      email: userInfo.email,
    };

    const response = await signUp(signUpInfo);

    console.log('response : ', response);
    if (response.status === 200) {
      dialogState.view = true;
      dialogState.title = 'íšŒì›ê°€ì…';
      dialogState.message = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    } else {
      // if (response.data.code === 1000) {
      //   errorState.view = true;
      //   errorState.message = response.data.message;
      // }

      errorState.view = true;
      errorState.message = response.data.message;
      return;
    }

    // validateForm();

    if (validateForm()) {
      dialogState.view = true;
      dialogState.title = 'íšŒì›ê°€ì…';
      dialogState.message = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    }

    errorMessage.value = ''; // ì´ì „ ì˜¤ë¥˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
    // íšŒì›ê°€ì… ë¡œì§ êµ¬í˜„
    // ìœ íš¨ì„± ê²€ì‚¬ ë“±ì„ ìˆ˜í–‰í•œ í›„ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” ì½”ë“œë¥¼ ì—¬ê¸°ì— ì‘ì„±í•©ë‹ˆë‹¤.

    // if (validateForm()) {
    //   const response = signUp(userInfo);

    //   if (response.response.data.status === 200) {
    //     dialogState.view = true;
    //     dialogState.title = 'íšŒì›ê°€ì…';
    //     dialogState.message = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    //   } else {
    //     dialogState.title = 'íšŒì›ê°€ì…';
    //     dialogState.message = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
    //   }
    // }

    // API í˜¸ì¶œ
    // signUp(userInfo);
    // dialogState.view = true;
    // dialogState.title = 'íšŒì›ê°€ì…';
    // dialogState.message = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
  };

  const onCancel = () => {
    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘ êµ¬í˜„
    emits('close');
  };

  const onCloseErrorState = () => {
    errorState.view = false;
  };

  const onDialogClose = () => {
    dialogState.view = false;
    emits('close');
  };

  // onBeforeMount(async () => {
  //   // ì‚¬ìš©ì íƒ€ì… ëª©ë¡ ì¡°íšŒ
  //   const userTypeList = await getUserTypeList();
  //   console.log('userTypeList : ', userTypeList);

  //   // ì‚¬ìš©ì ì§ê¸‰ ëª©ë¡ ì¡°íšŒ
  //   const userPositionList = await getUserPositionList();
  //   console.log('userPositionList : ', userPositionList);

  //   // ê¸°ê´€ë³„ ë¶€ì„œ ëª©ë¡ ì¡°íšŒ
  //   const departmentList = getDepartmentByInstitute(2);
  //   console.log('departmentList : ', departmentList);
  // });
</script>

<style>
  .form-section {
    display: flex;
    flex-direction: row;
    align-items: center; /* ë ˆì´ë¸”ê³¼ ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¥¼ ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
  }

  .child-section {
    padding-left: 25px;
    padding-right: 25px;
    padding: 10px;
  }

  .child-label {
    font-weight: 400;
  }

  .label-section {
    font-weight: 600;
    margin-right: 15px; /* ë ˆì´ë¸”ê³¼ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°„ì˜ ê°„ê²© ì¡°ì • */
    flex: 0 0 auto;
  }

  .select-container {
    flex: 1 1 100%; /* ì…€ë ‰íŠ¸ ë°•ìŠ¤ê°€ ê°€ë¡œë¡œ í™•ì¥ë˜ë„ë¡ ì„¤ì • */
  }

  .select-container select {
    width: 100%; /* ì…€ë ‰íŠ¸ ë°•ìŠ¤ê°€ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ë„ë¡ ì„¤ì • */
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  #select-position {
    width: 130px;
  }

  #select-department {
    width: 130px;
  }
</style>
